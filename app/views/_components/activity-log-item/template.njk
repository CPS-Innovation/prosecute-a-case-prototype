{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}

<div class="app-activity-log__item">
  <div class="app-activity-log__header">
    <h2 class="app-activity-log__title govuk-heading-s govuk-!-margin-bottom-1">{{ params.eventTitle }}</h2>
    <p class="app-activity-log__byline">
      By
      {% if params.event.user -%}
        {{params.event.user.firstName}}
        {{params.event.user.lastName}}
      {%- else -%}
        System
      {%- endif %} on
      <time datetime="{{ params.event.createdAt }}">
        {{- params.event.createdAt | isoDateString | govukDateTime -}}
      </time>
    </p>
  </div>
  <div class="app-activity-log__description">
    {% if params.event.title == 'DGA recorded' %}
      <div class="app-activity-log__box">
        {{ govukSummaryList({
          rows: [
            {
              key: {
                text: "Outcome"
              },
              value: {
                text: params.event.meta.outcome
              }
            }
          ]
        }) }}
      </div>
      <p class="app-log-card__note--link">
        <a class="govuk-link" href="/cases/{{ params.event.case.id }}/dga">View DGA outcome</a>
      </p>
    {% endif %}

    {% if params.event.title == 'Prosecutor assigned' %}
      <div class="app-activity-log__box">
        {{ govukSummaryList({
          rows: [
            {
              key: {
                text: "Prosecutor"
              },
              value: {
                text: params.event.meta.prosecutor.firstName + ' ' + params.event.meta.prosecutor.lastName
              }
            }
          ]
        }) }}
      </div>
      <p class="app-log-card__note--link">
        <a class="govuk-link" href="/cases/{{ params.event.case.id }}">View case</a>
      </p>
    {% endif %}

    {% if params.event.title == 'Witness marked as appearing in court' %}
      <div class="app-activity-log__box">
        {{ govukSummaryList({
          rows: [
            {
              key: {
                text: "Witness"
              },
              value: {
                text: params.event.meta.witness.firstName + ' ' + params.event.meta.witness.lastName
              }
            }
          ]
        }) }}
      </div>
      <p class="app-log-card__note--link">
        <a class="govuk-link" href="/cases/{{ params.event.case.id }}/witnesses">View witness</a>
      </p>
    {% endif %}

    {% if params.event.title == 'Witness marked as not attending court' %}
      <div class="app-activity-log__box">
        {{ govukSummaryList({
          rows: [
            {
              key: {
                text: "Witness"
              },
              value: {
                text: params.event.meta.witness.firstName + ' ' + params.event.meta.witness.lastName
              }
            },
            {
              key: {
                text: "Reason for marking the witness as not attending court"
              },
              value: {
                text: params.event.meta.reason
              }
            }
          ]
        }) }}
      </div>
      <p class="app-log-card__note--link">
        <a class="govuk-link" href="/cases/{{ params.event.case.id }}/witnesses">View witness</a>
      </p>
    {% endif %}

    {% if params.event.title == 'Witness statement marked as Section 9' %}
      <div class="app-activity-log__box">
        {{ govukSummaryList({
          rows: [
            {
              key: {
                text: "Witness"
              },
              value: {
                text: params.event.meta.witness.firstName + ' ' + params.event.meta.witness.lastName
              }
            },
            {
              key: {
                text: "Statement number"
              },
              value: {
                text: params.event.meta.witnessStatement.number
              }
            }
          ]
        })  }}
      </div>
      <p class="app-log-card__note--link">
        <a class="govuk-link" href="/cases/{{ params.event.case.id }}/witnesses">View statement</a>
      </p>
    {% endif %}

    {% if params.event.title == 'Witness statement unmarked as Section 9' %}
      <div class="app-activity-log__box">
        {{ govukSummaryList({
          rows: [
            {
              key: {
                text: "Witness"
              },
              value: {
                text: params.event.meta.witness.firstName + ' ' + params.event.meta.witness.lastName
              }
            },
            {
              key: {
                text: "Statement number"
              },
              value: {
                text: params.event.meta.witnessStatement.number
              }
            }
          ]
        })  }}
      </div>
      <p class="app-log-card__note--link">
        <a class="govuk-link" href="/cases/{{ params.event.case.id }}/witnesses">View statement</a>
      </p>
    {% endif %}

    {% if params.event.title == 'Case note added' %}
      <div class="app-activity-log__box">
        {{ govukSummaryList({
          rows: [
            {
              key: { text: 'Note' },
              value: { text: params.event.meta.content }
            }
          ]
        }) }}
      </div>
      <p class="app-log-card__note--link">
        <a class="govuk-link" href="/cases/{{ params.event.case.id }}/notes/{{ params.event.recordId }}">View note</a>
      </p>
    {% endif %}

    {% if params.event.title == 'Task note added' %}
      <div class="app-activity-log__box">
        {{ govukSummaryList({
          rows: [
            {
              key: { text: 'Task' },
              value: { text: params.event.meta.task.name }
            },
            {
              key: { text: 'Note' },
              value: { text: params.event.meta.description }
            }
          ]
        }) }}
      </div>
      <p class="app-log-card__note--link">
        <a class="govuk-link" href="/cases/{{ params.event.case.id }}/tasks/{{ params.event.meta.task.id }}">View task</a>
      </p>
    {% endif %}

    {% if params.event.title == 'Direction note added' %}
      <div class="app-activity-log__box">
        {% set directionDisplay %}
          {% if params.event.meta.direction.description.length > 75 %}
            {{ params.event.meta.direction.description | truncate(75) }}
          {% else %}
            {{ params.event.meta.direction.description }}
          {% endif %}
        {% endset %}
        {{ govukSummaryList({
          rows: [
            {
              key: { text: 'Direction' },
              value: { text: directionDisplay | trim }
            },
            {
              key: { text: 'Note' },
              value: { text: params.event.meta.description }
            }
          ]
        }) }}
      </div>
      <p class="app-log-card__note--link">
        <a class="govuk-link" href="/cases/{{ params.event.case.id }}/directions/{{ params.event.meta.direction.id }}">View direction</a>
      </p>
    {% endif %}

    {% if params.event.title == 'Task added' %}
      <div class="app-activity-log__box">
        {% set taskRows = [] %}

        {% set taskRows = (taskRows.push({
          key: { text: 'Task' },
          value: { text: params.event.meta.task.name }
        }), taskRows) %}

        {% if params.event.meta.assignedToUser %}
          {% set taskRows = (taskRows.push({
            key: { text: 'Owner' },
            value: { text: params.event.meta.assignedToUser.firstName + ' ' + params.event.meta.assignedToUser.lastName }
          }), taskRows) %}
        {% elif params.event.meta.assignedToTeam %}
          {% set taskRows = (taskRows.push({
            key: { text: 'Owner' },
            value: { text: params.event.meta.assignedToTeam.name + ' (' + params.event.meta.assignedToTeam.unit.name + ')' }
          }), taskRows) %}
        {% endif %}

        {{ govukSummaryList({
          rows: taskRows
        }) }}
      </div>
      <p class="app-log-card__note--link">
        <a class="govuk-link" href="/cases/{{ params.event.case.id }}/tasks/{{ params.event.recordId }}">View task</a>
      </p>
    {% endif %}

    {% if params.event.title == 'Task completed' or params.event.title == 'Task completed: Check New PCD case' %}
      <div class="app-activity-log__box">
        {% set taskRows = [] %}

        {% set taskRows = (taskRows.push({
          key: { text: 'Task' },
          value: { text: params.event.meta.task.name }
        }), taskRows) %}

        {% if params.event.meta.assignedToUser %}
          {% set taskRows = (taskRows.push({
            key: { text: 'Owner' },
            value: { text: params.event.meta.assignedToUser.firstName + ' ' + params.event.meta.assignedToUser.lastName }
          }), taskRows) %}
        {% elif params.event.meta.assignedToTeam %}
          {% set taskRows = (taskRows.push({
            key: { text: 'Owner' },
            value: { text: params.event.meta.assignedToTeam.name + ' (' + params.event.meta.assignedToTeam.unit.name + ')' }
          }), taskRows) %}
        {% endif %}

        {% if params.event.meta.decision %}
          {% set taskRows = (taskRows.push({
            key: { text: 'Decision' },
            value: { text: params.event.meta.decision }
          }), taskRows) %}
        {% endif %}

        {# Rejection-specific fields #}
        {% if params.event.meta.decision == 'Reject' %}

          {# Rejection reasons with optional details #}
          {% if params.event.meta.rejectionReasons and params.event.meta.rejectionReasons.length %}
            {% set reasonsHtml %}
              <ul class="govuk-list govuk-list--spaced govuk-!-margin-bottom-0">
                {% for reason in params.event.meta.rejectionReasons %}
                  <li>
                    {% if params.event.meta.rejectionDetails and params.event.meta.rejectionDetails[reason] and params.event.meta.rejectionDetails[reason] | trim %}
                      {{ reason }}:
                      <p>{{ params.event.meta.rejectionDetails[reason] }}</p>
                    {% else %}
                      {{ reason }}
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% endset %}
            {% set taskRows = (taskRows.push({
              key: { text: 'Reasons for rejection' },
              value: { html: reasonsHtml }
            }), taskRows) %}
          {% endif %}

          {# Police response date #}
          {% if params.event.meta.policeResponseDate %}
            {% set taskRows = (taskRows.push({
              key: { text: 'Date the police should respond' },
              value: { text: params.event.meta.policeResponseDate | govukDate }
            }), taskRows) %}
          {% endif %}

          {# Create reminder task #}
          {% if params.event.meta.createReminderTask %}
            {% set taskRows = (taskRows.push({
              key: { text: 'Do you want to create a task to remind you about when the police should respond back to you?' },
              value: { text: 'Yes' if params.event.meta.createReminderTask == 'yes' else 'No' }
            }), taskRows) %}
          {% endif %}

          {# Reminder due date (only if yes) #}
          {% if params.event.meta.createReminderTask == 'yes' and params.event.meta.reminderDueDate %}
            {% set taskRows = (taskRows.push({
              key: { text: 'Task due date' },
              value: { text: params.event.meta.reminderDueDate | govukDate }
            }), taskRows) %}
          {% endif %}

        {% endif %}

        {{ govukSummaryList({
          rows: taskRows
        }) }}
      </div>
      <p class="app-log-card__note--link">
        <a class="govuk-link" href="/cases/{{ params.event.case.id }}/tasks/{{ params.event.recordId }}">View task</a>
      </p>
    {% endif %}

    {% if params.event.title == 'Task marked as urgent' %}
      <div class="app-activity-log__box">
        {% set urgentTaskRows = [] %}

        {% set urgentTaskRows = (urgentTaskRows.push({
          key: { text: 'Task' },
          value: { text: params.event.meta.task.name }
        }), urgentTaskRows) %}

        {% set urgentTaskRows = (urgentTaskRows.push({
          key: { text: 'Reason for marking as urgent' },
          value: { text: params.event.meta.urgentNote }
        }), urgentTaskRows) %}

        {{ govukSummaryList({
          rows: urgentTaskRows
        }) }}
      </div>
      <p class="app-log-card__note--link">
        <a class="govuk-link" href="/cases/{{ params.event.case.id }}/tasks/{{ params.event.recordId }}">View task</a>
      </p>
    {% endif %}

    {% if params.event.title == 'Task marked as not urgent' %}
      <div class="app-activity-log__box">
        {% set notUrgentTaskRows = [] %}

        {% set notUrgentTaskRows = (notUrgentTaskRows.push({
          key: { text: 'Task' },
          value: { text: params.event.meta.task.name }
        }), notUrgentTaskRows) %}

        {% set notUrgentTaskRows = (notUrgentTaskRows.push({
          key: { text: 'Reason for marking as not urgent' },
          value: { text: params.event.meta.notUrgentNote }
        }), notUrgentTaskRows) %}

        {{ govukSummaryList({
          rows: notUrgentTaskRows
        }) }}
      </div>
      <p class="app-log-card__note--link">
        <a class="govuk-link" href="/cases/{{ params.event.case.id }}/tasks/{{ params.event.recordId }}">View task</a>
      </p>
    {% endif %}
  </div>
</div>
