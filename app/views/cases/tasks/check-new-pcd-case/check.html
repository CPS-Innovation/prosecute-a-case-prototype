{% extends "layouts/main.html" %}

{% set navId = 'cases' %}
{% set caption %} {{task.case.reference}} - Check new PCD case {% endset %}
{% set pageName = "Check details and complete task" %}

{% block beforeContent %}
  {{ govukBackLink({
    text: 'Back',
    href: 'javascript:history.back()'
  }) }}
{% endblock %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds-from-desktop">

      <span class="govuk-caption-l">{{caption}}</span>
      <h1 class="govuk-heading-l">{{pageName}}</h1>

      {# Complex value lookups #}

      {# Unit name lookup (Accept + Transfer flow) #}
      {% set unitName = "" %}
      {% if data.unitId %}
        {% for unit in units %}
          {% if unit.id == data.unitId %}
            {% set unitName = unit.name %}
          {% endif %}
        {% endfor %}
      {% endif %}

      {# Task owner name lookup (Accept + Transfer + RASSO flow) #}
      {% set taskOwnerName = "" %}
      {% if data.taskOwner %}
        {% if data.taskOwner.startsWith("user-") %}
          {% set userId = data.taskOwner | replace("user-", "") | int %}
          {% for user in users %}
            {% if user.id == userId %}
              {% set taskOwnerName = user.firstName + " " + user.lastName %}
            {% endif %}
          {% endfor %}
        {% elif data.taskOwner.startsWith("team-") %}
          {% set teamId = data.taskOwner | replace("team-", "") | int %}
          {% for team in teams %}
            {% if team.id == teamId %}
              {% set taskOwnerName = team.name %}
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endif %}

      {# Know prosecutor value (Accept + Early advice flow) #}
      {% set prosecutorValue = "" %}

      {% set prosecutorId = data.prosecutorId | int %}
      {% for prosecutor in prosecutors %}
        {% if prosecutor.id == prosecutorId %}
          {% set prosecutorValue = prosecutor.firstName + " " + prosecutor.lastName %}
        {% endif %}
      {% endfor %}
      

      {# Rejection reasons HTML (Reject flow) #}
      {% set reasonsHtml %}
        <ul class="govuk-list govuk-list--spaced">
          {% for reason in data.rejectionReasons %}
            <li>
              {% if data.rejectionDetails and data.rejectionDetails[reason] and data.rejectionDetails[reason] | trim %}
                <p class="govuk-!-margin-bottom-0">{{ reason }}:</p>
                <p>{{ data.rejectionDetails[reason] }}</p>
              {% else %}
                {{ reason }}
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% endset %}

      {{ govukSummaryList({
        rows: [
          {
            key: { text: "Decision" },
            value: { text: data.decision },
            actions: {
              items: [{
                href: '/cases/:caseId/tasks/:taskId/check-new-pcd-case' | replace(':caseId', task.case.id) | replace(':taskId', task.id),
                text: "Change",
                visuallyHiddenText: "decision"
              }]
            }
          },
          {
            key: { text: "Reasons for rejection" },
            value: { html: reasonsHtml },
            actions: {
              items: [{
                href: '/cases/:caseId/tasks/:taskId/check-new-pcd-case/reasons-for-rejection' | replace(':caseId', task.case.id) | replace(':taskId', task.id),
                text: "Change",
                visuallyHiddenText: "reasons for rejection"
              }]
            }
          } if data.decision == "Reject" and data.rejectionReasons and data.rejectionReasons.length,
          {
            key: { text: "Review task type" },
            value: { text: data.reviewTaskType },
            actions: {
              items: [{
                href: '/cases/:caseId/tasks/:taskId/check-new-pcd-case/review-task-type' | replace(':caseId', task.case.id) | replace(':taskId', task.id),
                text: "Change",
                visuallyHiddenText: "review task type"
              }]
            }
          } if data.reviewTaskType,
          {
            key: { text: "Case type" },
            value: { text: data.caseType },
            actions: {
              items: [{
                href: '/cases/:caseId/tasks/:taskId/check-new-pcd-case/case-type' | replace(':caseId', task.case.id) | replace(':taskId', task.id),
                text: "Change",
                visuallyHiddenText: "case type"
              }]
            }
          } if data.caseType,
          {
            key: { text: "Do you want to transfer the case?" },
            value: { text: data.transferCase },
            actions: {
              items: [{
                href: '/cases/:caseId/tasks/:taskId/check-new-pcd-case/transfer-case' | replace(':caseId', task.case.id) | replace(':taskId', task.id),
                text: "Change",
                visuallyHiddenText: "if you want to transfer the case"
              }]
            }
          } if data.decision == "Accept" and data.transferCase,
          {
            key: { text: "Do you want to change the area?" },
            value: { text: data.changeArea },
            actions: {
              items: [{
                href: '/cases/:caseId/tasks/:taskId/check-new-pcd-case/area' | replace(':caseId', task.case.id) | replace(':taskId', task.id),
                text: "Change",
                visuallyHiddenText: "if you want to change the area"
              }]
            }
          } if data.transferCase == "Yes" and data.changeArea,
          {
            key: { text: "Area" },
            value: { text: data.area },
            actions: {
              items: [{
                href: '/cases/:caseId/tasks/:taskId/check-new-pcd-case/area' | replace(':caseId', task.case.id) | replace(':taskId', task.id),
                text: "Change",
                visuallyHiddenText: "area"
              }]
            }
          } if data.transferCase == "Yes" and data.changeArea == "Yes" and data.area,
          {
            key: { text: "Unit" },
            value: { text: unitName },
            actions: {
              items: [{
                href: '/cases/:caseId/tasks/:taskId/check-new-pcd-case/unit' | replace(':caseId', task.case.id) | replace(':taskId', task.id),
                text: "Change",
                visuallyHiddenText: "unit"
              }]
            }
          } if data.transferCase == "Yes",
          {
            key: { text: "Do you want to assign the ‘Early advice manager triage’ task to an individual or team?" },
            value: { text: data.assignTo },
            actions: {
              items: [{
                href: '/cases/:caseId/tasks/:taskId/check-new-pcd-case/user-type' | replace(':caseId', task.case.id) | replace(':taskId', task.id),
                text: "Change",
                visuallyHiddenText: "if you want to assign to an individual or team"
              }]
            }
          } if data.decision == "Accept" and data.transferCase == "Yes" and data.reviewTaskType == "Early advice" and data.caseType == "RASSO" and data.assignTo,
          {
            key: { text: "Do you know who you want to assign the ‘Early advice manager triage’ task to?" },
            value: { text: data.knowPersonName },
            actions: {
              items: [{
                href: '/cases/:caseId/tasks/:taskId/check-new-pcd-case/person-name' | replace(':caseId', task.case.id) | replace(':taskId', task.id),
                text: "Change",
                visuallyHiddenText: "if you know the name of the person"
              }]
            }
          } if data.decision == "Accept" and data.transferCase == "Yes" and data.reviewTaskType == "Early advice" and data.caseType == "RASSO" and data.assignTo == "Individual" and data.knowPersonName,
          {
            key: { text: "Do you want to choose a specific role?" },
            value: { text: data.chooseSpecificRole },
            actions: {
              items: [{
                href: '/cases/:caseId/tasks/:taskId/check-new-pcd-case/role' | replace(':caseId', task.case.id) | replace(':taskId', task.id),
                text: "Change",
                visuallyHiddenText: "if you want to choose a specific role"
              }]
            }
          } if data.decision == "Accept" and data.transferCase == "Yes" and data.reviewTaskType == "Early advice" and data.caseType == "RASSO" and data.assignTo == "Individual" and data.knowPersonName == "No" and data.chooseSpecificRole,
          {
            key: { text: "Role" },
            value: { text: data.specificRole },
            actions: {
              items: [{
                href: '/cases/:caseId/tasks/:taskId/check-new-pcd-case/role' | replace(':caseId', task.case.id) | replace(':taskId', task.id),
                text: "Change",
                visuallyHiddenText: "role"
              }]
            }
          } if data.decision == "Accept" and data.transferCase == "Yes" and data.reviewTaskType == "Early advice" and data.caseType == "RASSO" and data.assignTo == "Individual" and data.knowPersonName == "No" and data.chooseSpecificRole == "Yes" and data.specificRole,
          {
            key: { text: "Task owner" },
            value: { text: taskOwnerName },
            actions: {
              items: [{
                href: ('/cases/:caseId/tasks/:taskId/check-new-pcd-case/person-name' if data.knowPersonName == "Yes" else '/cases/:caseId/tasks/:taskId/check-new-pcd-case/task-owner') | replace(':caseId', task.case.id) | replace(':taskId', task.id),
                text: "Change",
                visuallyHiddenText: "task owner"
              }]
            }
          } if data.decision == "Accept" and data.transferCase == "Yes" and data.reviewTaskType == "Early advice" and data.caseType == "RASSO" and data.taskOwner,
          {
            key: { text: "Do you know the name of the prosecutor you want to allocate?" },
            value: { text: data.knowProsecutorName },
            actions: {
              items: [{
                href: '/cases/:caseId/tasks/:taskId/check-new-pcd-case/know-prosecutor-name' | replace(':caseId', task.case.id) | replace(':taskId', task.id),
                text: "Change",
                visuallyHiddenText: "if you know the name of the prosecutor"
              }]
            }
          } if data.decision == "Accept" and data.reviewTaskType == "Early advice" and (data.transferCase == "No" or (data.transferCase == "Yes" and data.caseType != "RASSO")) and data.knowProsecutorName,
          {
            key: { text: "Prosecutor" },
            value: { text: prosecutorValue },
            actions: {
              items: [{
                href: '/cases/:caseId/tasks/:taskId/check-new-pcd-case/know-prosecutor-name' | replace(':caseId', task.case.id) | replace(':taskId', task.id),
                text: "Change",
                visuallyHiddenText: "prosecutor"
              }]
            }
          } if data.decision == "Accept" and data.reviewTaskType == "Early advice" and (data.transferCase == "No" or (data.transferCase == "Yes" and data.caseType != "RASSO")) and data.prosecutorId,
          {
            key: { text: "Date the police should respond" },
            value: { text: data.policeResponseDate | isoDateFromDateInput | govukDateTime },
            actions: {
              items: [{
                href: '/cases/:caseId/tasks/:taskId/check-new-pcd-case/police-response-date' | replace(':caseId', task.case.id) | replace(':taskId', task.id),
                text: "Change",
                visuallyHiddenText: "Date the police should respond"
              }]
            }
          } if data.decision == "Reject" and data.policeResponseDate and data.policeResponseDate.day and data.policeResponseDate.month and data.policeResponseDate.year,
          {
            key: { text: "Do you want to create a task to remind you about when the police should respond back to you?" },
            value: { text: "Yes" if data.createReminderTask == "Yes" else "No" },
            actions: {
              items: [{
                href: '/cases/:caseId/tasks/:taskId/check-new-pcd-case/create-reminder-task' | replace(':caseId', task.case.id) | replace(':taskId', task.id),
                text: "Change",
                visuallyHiddenText: "if you want to create a task to remind you about when the police should respond back to you"
              }]
            }
          } if data.decision == "Reject",
          {
            key: { text: "Task due date" },
            value: { text: data.reminderDueDate | isoDateFromDateInput | govukDateTime },
            actions: {
              items: [{
                href: '/cases/:caseId/tasks/:taskId/check-new-pcd-case/create-reminder-task' | replace(':caseId', task.case.id) | replace(':taskId', task.id),
                text: "Change",
                visuallyHiddenText: "Task due date"
              }]
            }
          } if data.decision == "Reject" and data.createReminderTask == "Yes" and data.reminderDueDate and data.reminderDueDate.day and data.reminderDueDate.month and data.reminderDueDate.year
        ]
      }) }}

      <form method="post">
        {{ govukButton({
          text: "Complete task"
        }) }}
      </form>
    </div>
  </div>
{% endblock %}
